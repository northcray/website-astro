---
import { DIRECTUS_API_URL } from "astro:env/client";
import MainLayout from "@layouts/MainLayout.astro";
import PageHeader from "@ui/PageHeader.astro";
import Container from "@ui/Container.astro";
import Markdown from "@ui/Markdown.astro";
import directus from "@lib/directus";

import type { InferGetStaticParamsType, InferGetStaticPropsType } from "astro";
import { readItems } from "@directus/sdk";

export async function getStaticPaths() {
  const articles = await directus.request(
    readItems("articles", {
      fields: [
        "id",
        "title",
        "image",
        "topic.*",
        "first_published_at",
        "tags",
        "blocks.collection" as any,
        "blocks.item.*" as any,
      ],
    }),
  );

  return articles.map((article) => ({
    params: { articleId: article.id, topicSlug: article.topic.slug },
    props: { article },
  }));
}

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { articleId } = Astro.params as Params;
const { article } = Astro.props as Props;
---

<MainLayout>
  <PageHeader
    title={article.title}
    breadcrumbs={[
      { label: "Home", href: "/" },
      { label: "Articles", href: "/articles" },
      {
        label: article.topic.title,
        href: `/articles/${article.topic.slug}`,
      },
      {
        label: "Article",
        href: `/articles/${article.topic.slug}/${article.id}`,
        active: true,
      },
    ]}
    meta={[
      {
        label: "Date",
        value: new Date(article.first_published_at).toDateString(),
      },
    ]}
  />

  {
    article.image && (
      <Container classes="my-8">
        <img
          src={`${DIRECTUS_API_URL}/assets/${article.image}`}
          alt={article.title}
          width={1000}
          height={500}
          class="h-auto w-auto"
        />
      </Container>
    )
  }

  {
    article.blocks.map((block) => (
      <Container key={block.item.id} class="my-8">
        {block.collection === "blocks_content" && (
          <Markdown>{block.item.content}</Markdown>
        )}
      </Container>
    ))
  }

  <Container classes="my-10">
    <Markdown>{article.content}</Markdown>
  </Container>

  {
    article.tags && (
      <Container>
        <h5>Tags</h5>
        <ul class="list-none my-10 p-0 m-0 flex gap-2">
          {article.tags?.map((tag: string) => (
            <li>
              <a
                href={`/articles/tags?tag=${tag}`}
                class="nc-tag nc-link nc-focus"
              >
                {tag}
              </a>
            </li>
          ))}
        </ul>
      </Container>
    )
  }
</MainLayout>

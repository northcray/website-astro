---
export const prerender = false;

import { actions } from "astro:actions";
import AccountLayout from "@layouts/AccountLayout.astro";
import { PUBLIC_TURNSTILE_SITE_KEY } from "astro:env/client";

// get email from query parameters
const url = new URL(Astro.request.url);
const emailParam = url.searchParams.get("email");

const result = Astro.getActionResult(actions.auth.identifyUser);
if (result && !result.error) {
  const { userExists, email } = result.data;
  if (userExists) {
    return Astro.redirect(`/account/signin?email=${email}`);
  } else {
    return Astro.redirect(`/account/register?email=${email}`);
  }
}

const registerResult = Astro.getActionResult(actions.auth.registerUser);

if (registerResult && registerResult.data?.success) {
  return Astro.redirect("/account/check-email");
}
---

<AccountLayout header="Membership Form">
  {JSON.stringify(registerResult?.error, null, 2)}
  <form class="form" method="POST" action={actions.auth.registerUser}>
    <div class="flex flex-col md:flex-row gap-4">
      <div class="field">
        <label class="label" for="first_name">First Name</label>
        <input
          id="first_name"
          name="first_name"
          type="text"
          required
          autofocus
          class="input"
          placeholder="Jane"
          autocomplete="first_name"
        />
      </div>
      <div class="field">
        <label class="label" for="last_name">Last Name</label>
        <input
          id="last_name"
          name="last_name"
          type="text"
          required
          class="input"
          placeholder="Smith"
          autocomplete="last_name"
        />
      </div>
    </div>

    <div class="field">
      <label class="label" for="email">Email</label>
      <input
        id="email"
        name="email"
        type="email"
        required
        class="input"
        value={emailParam || ""}
        placeholder="someone@example.com"
        autocomplete="email"
      />
    </div>
    <div class="field">
      <label class="label" for="password">Password</label>
      <input
        id="password"
        name="password"
        type="password"
        required
        class="input"
        placeholder="Enter a secure password"
        autocomplete="new-password"
      />
    </div>
    <div class="field">
      <label class="label" for="confirm_password">Confirm Password</label>
      <input
        id="confirm_password"
        name="confirm_password"
        type="password"
        required
        class="input"
        placeholder="Enter the password again"
        autocomplete="new-password"
      />
    </div>

    <p class="text-sm">
      By continuing, you agree to our <a href="/privacy-policy" target="_blank"
        >Privacy Policy</a
      >, including how we use your data to manage your subscription and send you
      local updates.
    </p>

    <!--<div class="field">-->
    <!--  <label class="label" for="address">Address</label>-->
    <!--  <select id="address" name="address" required class="input"></select>-->
    <!--</div>-->

    <!--go away spammers-->

    <div class="cf-turnstile" data-sitekey={PUBLIC_TURNSTILE_SITE_KEY}></div>

    <button class="mt-4 button sm:max-w-fit" type="submit">Continue</button>
  </form>

  <h4 class="mt-10">Existing users</h4>
  <ul class="my-2">
    <li>
      <a href="/account/signin" class="nc-link nc-focus text-lg"
        >Sign in with email and password</a
      >
    </li>
  </ul>
</AccountLayout>

---
import SectionHeader from "../../components/ui/SectionHeader.astro";
export const prerender = false;
import Alert from "../../components/ui/Alert.astro";
import { loggedInPath } from "../../constants";
import AccountLayout from "@layouts/AccountLayout.astro";

import { getCurrentUser } from "@lib/auth";

const user = await getCurrentUser(Astro.cookies);

if (user) {
  return Astro.redirect(loggedInPath);
}

const errors = [];

// get email from query parameters
const url = new URL(Astro.request.url);
const emailParam = url.searchParams.get("email");

// Handle form submission
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const email = formData.get("email")?.toString();
  const password = formData.get("password")?.toString();

  if (email && password) {
    const { login } = await import("../../lib/auth.ts");
    const user = await login(Astro.cookies, email, password);

    if (user) {
      return Astro.redirect(loggedInPath);
    } else {
      errors.push("Invalid email or password. Please try again.");
    }
  }
}
---

<AccountLayout header="Sign in">
  {errors.length > 0 && <Alert errors={errors} />}
  <form class="form" method="POST">
    <div class="field">
      <label class="label" for="email">Email</label>
      <input
        id="email"
        name="email"
        type="email"
        required
        class="input"
        value={emailParam || ""}
        placeholder="someone@example.com"
        autocomplete="email"
      />
    </div>
    <div class="field">
      <label class="label" for="password">Password</label>
      <input
        id="password"
        name="password"
        type="password"
        required
        class="input"
        autofocus={emailParam ? "true" : undefined}
        autocomplete="current-password"
      />
    </div>

    <button class="mt-4 button sm:max-w-fit" type="submit">Sign in</button>
  </form>
  <h4 class="mt-10">New residents</h4>
  <ul class="my-2">
    <li>
      <a href="/account/register" class="nc-link nc-focus text-lg"
        >Create an account</a
      >
    </li>
  </ul>
  <h4 class="mt-10">Problems signing in</h4>
  <ul class="my-2">
    <li>
      <a href="/account/forgot-password" class="nc-link nc-focus text-lg"
        >I forgot my password</a
      >
    </li>
  </ul>
</AccountLayout>

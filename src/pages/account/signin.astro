---
export const prerender = false;
import { actions } from "astro:actions";

import Alert from "@ui/Alert.astro";
import AccountLayout from "@layouts/AccountLayout.astro";
import { getCurrentUser } from "@lib/auth";
import { loggedInPath } from "../../constants";

const user = await getCurrentUser(Astro.cookies);

if (user) {
  return Astro.redirect(loggedInPath);
}

// get email from query parameters
const url = new URL(Astro.request.url);
const emailParam = url.searchParams.get("email") || "";

// Handle form submission
const result = Astro.getActionResult(actions.auth.signin);

let errors: string[] = [];
if (result && result.error) {
  errors = [result.error.message];
}

if (result?.data?.redirect && !result.error) {
  return Astro.redirect(result.data.redirect);
}
---

<AccountLayout header="Sign in">
  {result?.error && <Alert errors={[result.error.message]} />}
  <form class="form" method="POST" action={actions.auth.signin}>
    <div class="field">
      <label class="label" for="email">Email</label>
      <input
        id="email"
        name="email"
        type="email"
        required
        class="input"
        value={emailParam || ""}
        autofocus={!emailParam ? "true" : undefined}
        placeholder="someone@example.com"
        autocomplete="email"
      />
    </div>
    <div class="field">
      <label class="label" for="password">Password</label>
      <input
        id="password"
        name="password"
        type="password"
        required
        class="input"
        autofocus={emailParam ? "true" : undefined}
        autocomplete="current-password"
      />
    </div>

    <button class="mt-4 button sm:max-w-fit" type="submit">Sign in</button>
  </form>
  <h4 class="mt-10">New residents</h4>
  <ul class="my-2">
    <li>
      <a href="/account/register" class="nc-link nc-focus text-lg"
        >Create an account</a
      >
    </li>
  </ul>
  <h4 class="mt-10">Problems signing in</h4>
  <ul class="my-2">
    <li>
      <a href="/account/forgot-password" class="nc-link nc-focus text-lg"
        >I forgot my password</a
      >
    </li>
  </ul>
</AccountLayout>
